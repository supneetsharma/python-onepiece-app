pipeline {
  agent any
  options {
    timestamps()
    skipDefaultCheckout(true)
  }
  environment {
    VENV = 'venv'
    SCANNER_HOME = tool 'sonar-scanner'
  }

  stages {

    stage('Git checkout') {
      steps {
        checkout scm
      }
    }

    stage('Python build') {
      steps {
        sh '''
          python3 -V
          python3 -m venv ${VENV}
          . ${VENV}/bin/activate
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
        '''
      }
    }

    stage('Lint & Test') {
      steps {
        sh '''
          . ${VENV}/bin/activate
          pip install pytest flake8 pytest-cov
          flake8 . || true
          mkdir -p reports
          pytest -q --junitxml=reports/junit.xml --cov=. --cov-report xml:coverage.xml || true
        '''
      }
      post {
        always {
          junit 'reports/junit.xml'
          archiveArtifacts artifacts: 'coverage.xml', allowEmptyArchive: true
        }
      }
    }

    stage('SonarQube Analysis') {
      when { expression { fileExists('sonar-project.properties') } }
      steps {
        withSonarQubeEnv('sonarqube-local') {
          sh '''
            ${SCANNER_HOME}/bin/sonar-scanner
          '''
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
    }
  }
}
